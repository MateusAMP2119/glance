- name: Lab
  columns:
    - size: small
      widgets:
      - type: server-stats
      - type: docker-containers

    - size: full
      widgets:
      # Summary widget
      - type: split-column
        widgets:
          - type: custom-api
            title: DNS Query Breakdown
            url: https://adguard.bymarreco.com/control/stats
            headers:
              Authorization: Basic ${ADGUARD_AUTH}
            template: |
              {{ $total := .JSON.Int "num_dns_queries" }}
              {{ $blocked := .JSON.Int "num_blocked_filtering" }}
              {{ $allowed := sub $total $blocked }}
              {{ $blockedPct := 0 }}{{ if gt $total 0 }}{{ $blockedPct = mul (div (toFloat $blocked) (toFloat $total)) 100 }}{{ end }}
              {{ $allowedPct := 0 }}{{ if gt $total 0 }}{{ $allowedPct = sub 100 $blockedPct }}{{ end }}
              <style>
                .donut-row { margin-top: 12px; display:flex; align-items:center; gap:16px; }
                .dns-donut { position: relative; width: 160px; aspect-ratio: 1 / 1; border-radius: 50%; display: grid; place-items: center; }
                .dns-donut-inner { width: 90px; aspect-ratio: 1 / 1; border-radius: 50%; background: var(--color-background); display: flex; flex-direction: column; align-items: center; justify-content: center; }
                .dns-breakdown-legend { display:flex; flex-direction:column; gap:8px; }
                .legend-row { display:flex; align-items:center; gap:8px; }
                .swatch { width:14px; height:14px; border-radius:3px; }
              </style>
              <div class="card padding-16">
                <div class="donut-row">
                  <div class="dns-donut" style="background: conic-gradient(var(--color-positive) {{ printf "%.4f" $allowedPct }}%, var(--color-negative) 0);">
                    <div class="dns-donut-inner">
                      <div class="size-h6 color-subdue">Total</div>
                      <div class="size-h3 color-highlight">{{ formatNumber $total }}</div>
                    </div>
                  </div>
                  <div class="dns-breakdown-legend size-h6">
                    <div class="legend-row"><span class="swatch" style="background:var(--color-positive);"></span><span>Allowed: <strong class="color-positive">{{ formatNumber $allowed }}</strong> ({{ printf "%.1f" $allowedPct }}%)</span></div>
                    <div class="legend-row"><span class="swatch" style="background:var(--color-negative);"></span><span>Blocked: <strong class="color-negative">{{ formatNumber $blocked }}</strong> ({{ printf "%.1f" $blockedPct }}%)</span></div>
                    <div class="legend-row"><span class="swatch" style="background:var(--color-background-secondary);"></span><span>Net Allowed: {{ formatNumber $allowed }} / {{ formatNumber $total }}</span></div>
                  </div>
                </div>
              </div>
          - type: custom-api
            title: Performance & Insights
            url: https://adguard.bymarreco.com/control/stats
            headers:
              Authorization: Basic ${ADGUARD_AUTH}
            template: |
              {{ $total := .JSON.Int "num_dns_queries" }}
              {{ $blocked := .JSON.Int "num_blocked_filtering" }}
              {{ $allowed := sub $total $blocked }}
              {{ $blockedPct := 0 }}{{ if gt $total 0 }}{{ $blockedPct = mul (div (toFloat $blocked) (toFloat $total)) 100 }}{{ end }}
              {{ $allowedPct := 0 }}{{ if gt $total 0 }}{{ $allowedPct = sub 100 $blockedPct }}{{ end }}
              {{ $avgProcMs := mul (.JSON.Float "avg_processing_time") 1000 }}
              <style>
                .perf-metrics { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:8px; }
                .metric { display:flex; flex-direction:column; gap:4px; }
                .pill { border-radius:6px; background:var(--color-background-secondary); padding:4px 10px; }
                .insights { list-style:none; margin:16px 0 0; padding:0; }
                .insights li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--color-background-secondary); }
                .insights li:last-child { border-bottom:none; }
              </style>
              <div class="card padding-16">
                <div class="size-h4">Performance & Filtering</div>
                <div class="perf-metrics">
                  <div class="metric">
                    <div class="size-h6 color-subdue">Avg Processing</div>
                    <div class="size-h2">{{ printf "%.1f" $avgProcMs }} <span class="size-h5 color-subdue">ms</span></div>
                  </div>
                </div>
                <div class="size-h6 margin-top-10"><strong>Filtering Level:</strong> <span class="pill">{{ if ge $blockedPct (toFloat 50) }}Aggressive{{ else if ge $blockedPct (toFloat 30) }}Moderate{{ else if ge $blockedPct (toFloat 15) }}Light{{ else }}Minimal{{ end }}</span></div>
                <ul class="insights size-h6">
                  {{ range $i, $ := .JSON.Array "top_upstreams_responses" }}{{ if eq $i 0 }}{{ $upResp := (.Get "@values.0").Int "" }}<li><span>Cache Hit Rate</span><span>{{ if gt $total 0 }}{{ printf "%.1f" (mul (div (sub $total $upResp) (toFloat $total)) 100) }}%{{ else }}N/A{{ end }}</span></li>{{ end }}{{ end }}
                  {{ range $i, $ := .JSON.Array "top_upstreams_avg_time" }}{{ if eq $i 0 }}<li><span>Upstream Avg Time</span><span>{{ printf "%.1f" (mul ((.Get "@values.0").Float "") 1000) }} ms</span></li>{{ end }}{{ end }}
                  {{ range $i, $ := .JSON.Array "top_clients" }}{{ if eq $i 0 }}<li><span>Top Client Share</span><span>{{ printf "%.1f" (mul (div (toFloat ((.Get "@values.0").Int "")) (toFloat $total)) 100) }}% ({{ (.Get "@keys.0").String "" }})</span></li>{{ end }}{{ end }}
                  {{ range .JSON.Array "top_queried_domains" }}{{ $k := (.Get "@keys.0").String "" }}{{ if eq $k "a.root-servers.net" }}<li><span>Root Server Share</span><span>{{ printf "%.1f" (mul (div (toFloat ((.Get "@values.0").Int "")) (toFloat $total)) 100) }}% ({{ formatNumber ((.Get "@values.0").Int "") }})</span></li>{{ end }}{{ end }}
                  <li><span>Allowed vs Blocked</span><span>{{ printf "%.1f" $allowedPct }}% / {{ printf "%.1f" $blockedPct }}%</span></li>
                </ul>
              </div>
      - type: split-column
        widgets:
          - type: custom-api
            title: Top Queried
            url: https://adguard.bymarreco.com/control/stats
            headers:
              Authorization: Basic ${ADGUARD_AUTH}
            template: |
              {{ $total := .JSON.Int "num_dns_queries" }}
              <ol class="list list-gap-20 list-with-separator">
                {{ range $i, $ := .JSON.Array "top_queried_domains" }}
                  {{ if lt $i 12 }}
                    {{ $kRes := .Get "@keys.0" }}
                    {{ $vRes := .Get "@values.0" }}
                    {{ $k := $kRes.String "" }}
                    {{ $v := $vRes.Int "" }}
                    <li class="flex justify-between"><span>{{ $k }}</span><span class="color-highlight">{{ formatNumber $v }} <span class="color-subdue size-h6">({{ printf "%.2f" (mul (div (toFloat $v) (toFloat $total)) 100) }}%)</span></span></li>
                  {{ end }}
                {{ end }}
              </ol>
          - type: custom-api
            title: Top Blocked
            url: https://adguard.bymarreco.com/control/stats
            headers:
              Authorization: Basic ${ADGUARD_AUTH}
            template: |
              {{ $total := .JSON.Int "num_dns_queries" }}
              <ol class="list list-gap-20 list-with-separator">
                {{ range $i, $ := .JSON.Array "top_blocked_domains" }}
                  {{ if lt $i 12 }}
                    {{ $kRes := .Get "@keys.0" }}
                    {{ $vRes := .Get "@values.0" }}
                    {{ $k := $kRes.String "" }}
                    {{ $v := $vRes.Int "" }}
                    <li class="flex justify-between"><span>{{ $k }}</span><span class="color-negative">{{ formatNumber $v }} <span class="color-subdue size-h6">({{ printf "%.2f" (mul (div (toFloat $v) (toFloat $total)) 100) }}%)</span></span></li>
                  {{ end }}
                {{ end }}
              </ol>

      # Top Clients
      - type: custom-api
        title: Top Clients
        url: https://adguard.bymarreco.com/control/stats
        headers:
          Authorization: Basic ${ADGUARD_AUTH}
        template: |
          {{ $total := .JSON.Int "num_dns_queries" }}
          <ol class="list list-gap-20 list-with-separator">
            {{ range $i, $ := .JSON.Array "top_clients" }}
              {{ if lt $i 12 }}
                {{ $kRes := .Get "@keys.0" }}
                {{ $vRes := .Get "@values.0" }}
                {{ $k := $kRes.String "" }}
                {{ $v := $vRes.Int "" }}
                <li class="flex justify-between"><span>{{ $k }}</span><span class="color-highlight">{{ formatNumber $v }} <span class="color-subdue size-h6">({{ printf "%.2f" (mul (div (toFloat $v) (toFloat $total)) 100) }}%)</span></span></li>
              {{ end }}
            {{ end }}
          </ol>
